--CREATING NEW DATABASE
create database marathon;

--USING THAT DATABASE
use marathon;

-- CREATING TABLE DOCTOR
CREATE TABLE DOCTOR
(
	DOCTOR_ID VARCHAR(6) PRIMARY KEY,
	DR_FIRST_NAME VARCHAR(15),
	DR_MIDDLE_NAME VARCHAR(15),
	DR_LAST_NAME VARCHAR(15)
)

-- INSERTING VALUES IN DOCTOR
INSERT INTO DOCTOR VALUES('D1','SOHAN','SANJAY','UBALE');
INSERT INTO DOCTOR VALUES('D2','ABHISHEK','ASHOK','NAGARKAR');
INSERT INTO DOCTOR VALUES('D3','HRUSHANT','NITIN','RAGHWARTE');
INSERT INTO DOCTOR VALUES('D4','ABHIJEET','ANIL','RATHORE');
INSERT INTO DOCTOR VALUES('D5','VISHHAL','VISHNU','DAWANE');

--DISPLAING ALL DOCTORS
SELECT * FROM DOCTOR;

--CREATING TABLE PATIENT
CREATE TABLE PATIENT
(
	PATIENT_ID VARCHAR(6) PRIMARY KEY,
	P_FIRST_NAME VARCHAR(15),
	P_MIDDLE_NAME VARCHAR(15),
	P_LAST_NAME VARCHAR(15),
	P_ADDRESS VARCHAR(30),
	CITY VARCHAR(15),
	CONTACT_NUMBER VARCHAR(10),
	P_AGE INT
)

--INSERTING VALUES IN PATIENT TABLE
INSERT INTO PATIENT VALUES('P1','HARSHWARDHAN','SUNIL','GUNJAL','MG COLONY','BEED','1111111111',15);
INSERT INTO PATIENT VALUES('P2','TARIK','JAVED','PATHAN','ABC ROAD','NASHIK','2222222222',25);
INSERT INTO PATIENT VALUES('P3','SHLOK','ANIL','BUNDELE','XYZ CHOWK','NASHIK','3333333333',35);
INSERT INTO PATIENT VALUES('P4','PRAJWAL','SANJAY','NALKAR','XYZ COLONY','RAHATA','4444444444',45);
INSERT INTO PATIENT VALUES('P5','KRISHNA','BHANUDAS','GUNJAL','XYZ ROAD','RAHATA','5555555555',55);
INSERT INTO PATIENT VALUES('P6','YASH','MAHESH','GOSAVI','PQR CHOWK','SHIRDI','6666666666',65);
INSERT INTO PATIENT VALUES('P7','DHIRAJ','SUNIL','CHANDAR','PQR COLONY','SHIRDI','7777777777',75);
INSERT INTO PATIENT VALUES('P8','ATHARVA','SANJAY','BHANAGE','PQR ROAD','RAHATA','888888888',85);

--DISPLAYING ALL PATIENT
SELECT * FROM PATIENT;

-- CREATING TABLE APPOINTMENT
CREATE TABLE APPOINTMENT
(
	APP_NUMBER VARCHAR(6) PRIMARY KEY,
	APP_DATE DATE,
	APP_TIME VARCHAR(8),
	APP_REASON VARCHAR(30),
	DOCTOR_ID VARCHAR(6) REFERENCES DOCTOR(DOCTOR_ID),
	PATIENT_ID VARCHAR(6) REFERENCES PATIENT(PATIENT_ID)
)

--INSERTING VALUES IN THE APPOINTMENT TABLE
INSERT INTO APPOINTMENT VALUES('A1','2023-01-01','10:30 AM','STOMACH PAIN','D1','P1');
INSERT INTO APPOINTMENT VALUES('A2','2023-01-01','06:30 PM','HEAD PAIN','D1','P2');
INSERT INTO APPOINTMENT VALUES('A3','2023-02-02','10:30 AM','BODY PAIN','D5','P3');
INSERT INTO APPOINTMENT VALUES('A4','2023-02-02','06:30 AM','HAND PAIN','D2','P4');
INSERT INTO APPOINTMENT VALUES('A5','2023-03-03','10:30 AM','LEGS PAIN','D3','P7');
INSERT INTO APPOINTMENT VALUES('A6','2023-03-03','06:30 AM','BREATHING PROBLEM','D5','P8');

-- DISPLAYING ALL THE APPOINTMENT
SELECT * FROM APPOINTMENT;

-- CREATIING TABLE BILL
CREATE TABLE BILL
(
	BILL_NUMBER VARCHAR(6) PRIMARY KEY,
	BILL_DATE DATE,
	BILL_STATUS VARCHAR(10),
	BILL_AMOUNT DECIMAL(7,2),
	APP_NUMBER VARCHAR(6) REFERENCES APPOINTMENT(APP_NUMBER)
)

--INSERTING VALUES IN BILL TABLE
INSERT INTO BILL VALUES('B1','2023-01-01','SUCCESSFUL', 500.00,'A1')
INSERT INTO BILL VALUES('B2','2023-01-01','PENDING', 500.00,'A2')
INSERT INTO BILL VALUES('B3','2023-02-02','PENDING', 1000.00,'A3')
INSERT INTO BILL VALUES('B4','2023-02-02','SUCCESSFUL', 1000.00,'A4')
INSERT INTO BILL VALUES('B5','2023-03-03','PENDING', 1000.00,'A5')
INSERT INTO BILL VALUES('B6','2023-03-03','PENDING', 1500.00,'A6')

--DISPLAYING ALL THE BILLS
SELECT * FROM BILL;

--CREATING PAYMENT TABLE
CREATE TABLE PAYMENT
(
	PAYMENT_ID VARCHAR(6) PRIMARY KEY,
	PAY_DATE DATE,
	PAY_MODE VARCHAR(10),
	PAY_AMOUNT DECIMAL(7,2),
	BILL_NUMBER VARCHAR(6) REFERENCES BILL(BILL_NUMBER)
)

--INSERTING VALULES IN PAYMENT TABLE
INSERT INTO PAYMENT VALUES('PAY1','2023-01-01','CASH',500.00,'B1');
INSERT INTO PAYMENT VALUES('PAY2','2023-01-01',NULL,500.00,'B2')
INSERT INTO PAYMENT VALUES('PAY3','2023-01-01',NULL,1000.00,'B3')
INSERT INTO PAYMENT VALUES('PAY4','2023-01-01','UPI',1000.00,'B4')
INSERT INTO PAYMENT VALUES('PAY5','2023-01-01',NULL,1000.00,'B5')
INSERT INTO PAYMENT VALUES('PAY6','2023-01-01',NULL,1500.00,'B6')

--DISPLAYING ALL THE PAYMENT
SELECT * FROM PAYMENT;

--QUERIES Q1
--DISPLAYING ALL THE PATIENT
SELECT * FROM PATIENT;

--INSERTING VALUES IN PATIENT TABLE
INSERT INTO PATIENT VALUES('P003','STEVA',NULL,'WILLIAM','423, II CROSS STREET','MUMBAI','9944556677',23);

INSERT INTO PATIENT VALUES('P006','STANES',NULL,'WILLIAM','423, II CROSS STREET','MUMBAI','9944556677',23);

-- DISPLAYING ALL DOCTOR
SELECT * FROM DOCTOR;
--INSERTING VALUES IN DOCTOR TABLE
INSERT INTO DOCTOR VALUES('D15','NANCY','JENNIFER','JOHN')

--DISPLAYING ALL THE APPOINTMENT
SELECT * FROM APPOINTMENT;

--INSERTING VALUES IN APPOINTMENT TABLE
INSERT INTO APPOINTMENT VALUES('A08','2022-06-12','9:30 AM','NASAL BLOCK','D15','P003');

INSERT INTO APPOINTMENT VALUES('A10','2022-06-12','9:30 AM','NASAL BLOCK','D15','P006');

--DISPLAYING ALL THE BILLS
SELECT * FROM BILL;

--INSERTING VALUES IN BILL TABLE
INSERT INTO BILL VALUES('B02','2022-06-12','PAID',1500,'A08');

INSERT INTO BILL VALUES('B03','2022-08-15','NOT PAID',1500,'A10');

-- DISPLAYING ALL THE PAYMENT
SELECT * FROM PAYMENT
INSERT INTO PAYMENT VALUES('1007','2022-07-12','CASH',1000,'B02');

-- QUERIES Q2

SELECT * FROM DOCTOR;
SELECT * FROM PATIENT;
SELECT * FROM APPOINTMENT;

-- TOTAL 'NUMBER OF APPOINTMENTS' FOR EACH DOCTOR
SELECT D.DOCTOR_ID,CONCAT(D.DR_FIRST_NAME,' ',D.DR_LAST_NAME) AS 'DOCTOR NAME', COUNT(A.DOCTOR_ID)  AS 'NO OF APPOINTMENTS' 
FROM DOCTOR D,APPOINTMENT A WHERE D.DOCTOR_ID = A.DOCTOR_ID GROUP BY A.DOCTOR_ID, D.DOCTOR_ID,D.DR_FIRST_NAME,D.DR_LAST_NAME;


SELECT * FROM APPOINTMENT;
SELECT * FROM PATIENT;

-- 'AVERAGE AGE' OF PATIENT WHO HAD THEIR APPOINTMENTS IN 'JAN 2023'
SELECT AVG(P.P_AGE) AS 'AVERAGE AGE OF PATIENTS IN JAN 2023' FROM APPOINTMENT A, PATIENT P 
WHERE A.PATIENT_ID = P.PATIENT_ID AND DATEPART(MONTH,A.APP_DATE) = 01 AND DATEPART(YEAR,A.APP_DATE) = 2023;


SELECT * FROM PATIENT;
SELECT * FROM BILL;

-- 'TOTAL BILL AMOUNTS' FOR EACH PATIENT
SELECT P.PATIENT_ID, P.P_FIRST_NAME,P.P_LAST_NAME, SUM(B.BILL_AMOUNT) AS 'TOTAL BILL AMOUNT '
FROM BILL B, PATIENT P, APPOINTMENT A 
WHERE P.PATIENT_ID = A.PATIENT_ID AND A.APP_NUMBER = B.APP_NUMBER GROUP BY P.PATIENT_ID, P.P_FIRST_NAME,P.P_LAST_NAME;

SELECT * FROM APPOINTMENT;
SELECT * FROM BILL;
SELECT * FROM PAYMENT;
SELECT * FROM PATIENT

-- PATIENTS WHO PAID USING 'CASH' AS A MODE OF PAYMENT
SELECT P.P_FIRST_NAME,P.CITY,A.APP_DATE,PAY.PAY_MODE,PAY.PAY_DATE
FROM PATIENT P, APPOINTMENT A, BILL B, PAYMENT PAY 
WHERE P.PATIENT_ID = A.PATIENT_ID AND A.APP_NUMBER = B.APP_NUMBER AND B.BILL_NUMBER = PAY.BILL_NUMBER
AND PAY_MODE = 'CASH';


SELECT * FROM APPOINTMENT;
INSERT INTO APPOINTMENT VALUES('A11','2023-05-05','10:00 AM','COLD AND COUGH','D1','P8');

-- BUSIEST DOCTOR IN THE HOSPITAL ON THE TOP
-- DOCTORS AND THEIR 'NO OF APPOINTMENTS' IN DESCENDING ORDER
SELECT CONCAT(D.DR_FIRST_NAME,' ',D.DR_LAST_NAME) AS 'DOCTOR FULL NAME', COUNT(A.DOCTOR_ID) AS 'NO OF APPOINTMENTS' 
FROM DOCTOR D, APPOINTMENT A
WHERE D.DOCTOR_ID = A.DOCTOR_ID
GROUP BY D.DR_FIRST_NAME, D.DR_LAST_NAME 
ORDER BY COUNT(A.DOCTOR_ID) DESC;

-- Queries Q3 
-- FUNCTIONS

--Q1

--QUERY
SELECT * FROM APPOINTMENT WHERE APPOINTMENT.APP_DATE = '2023-01-01'

-- DESCRIBE APPOINTMENT
SP_HELP APPOINTMENT

-- FUNCTION TO SHOW ALL APPOINTMENT FOR GIVEN DATE
GO
CREATE FUNCTION SHOW_ALL_APPOINTMENT_FOR_GIVEN_DATE (@APP_DATE DATE)
RETURNS @MY_TBL TABLE (APP_NUMBER VARCHAR(6), APP_DATE DATE, APP_TIME TIME, APP_REASON VARCHAR(30),DOCTOR_ID VARCHAR(6),PATIENT_ID VARCHAR(6) )
AS
BEGIN
	INSERT @MY_TBL
	SELECT * FROM APPOINTMENT WHERE APPOINTMENT.APP_DATE = @APP_DATE;
	RETURN
END
GO

--FUNCTION CALL TO Q1
SELECT * FROM DBO.SHOW_ALL_APPOINTMENT_FOR_GIVEN_DATE('2023-01-01');

--Q2
--SELECT COUNT(A.DOCTOR_ID) FROM DOCTOR D, APPOINTMENT A ,PATIENT P
--WHERE D.DOCTOR_ID = A.DOCTOR_ID AND P.PATIENT_ID = A.PATIENT_ID AND D.DOCTOR_ID = 'D1'

--QUERY
SELECT COUNT(A.DOCTOR_ID), A.APP_NUMBER,A.APP_DATE,A.APP_REASON,P.P_FIRST_NAME FROM DOCTOR D, APPOINTMENT A ,PATIENT P
WHERE D.DOCTOR_ID = A.DOCTOR_ID AND P.PATIENT_ID = A.PATIENT_ID AND D.DOCTOR_ID = 'D1'
GROUP BY  A.APP_NUMBER,A.APP_DATE,A.APP_REASON,P.P_FIRST_NAME;

--DESCRIBE DOCTOR
SP_HELP DOCTOR

--FUNCTION THAT ACCEPTS DOCTOR_ID AND SHOWS APPOINTMENT DETAILS WITH PATIENT NAME
GO
CREATE FUNCTION SHOW_APPOINTMENT_PATIENTNAME(@DOCTOR_ID VARCHAR(6))
RETURNS @SHOW_APP_PATIENT_TBL TABLE(COUNT INT, APP_NUMBER VARCHAR(6), APP_DATE DATE, APP_REASON VARCHAR(30),PATIENT_NAME VARCHAR(15))
AS
BEGIN
INSERT @SHOW_APP_PATIENT_TBL
SELECT COUNT(A.DOCTOR_ID), A.APP_NUMBER,A.APP_DATE,A.APP_REASON,P.P_FIRST_NAME FROM DOCTOR D, APPOINTMENT A ,PATIENT P
WHERE D.DOCTOR_ID = A.DOCTOR_ID AND P.PATIENT_ID = A.PATIENT_ID AND D.DOCTOR_ID = 'D1'
GROUP BY  A.APP_NUMBER,A.APP_DATE,A.APP_REASON,P.P_FIRST_NAME;
RETURN
END
GO
DROP FUNCTION SHOW_APPOINTMENT_PATIENTNAME

--FUNCTION CALL TO Q2
SELECT * FROM DBO.SHOW_APPOINTMENT_PATIENTNAME('D1');




--Q3

--QUERY
SELECT TOP 1 APP_DATE FROM APPOINTMENT A, DOCTOR D WHERE A.DOCTOR_ID = D.DOCTOR_ID AND D.DOCTOR_ID = 'D1'
ORDER BY APP_DATE DESC

--LATEST APPOINTMENT DATE FOR DOCTOR WITH GIVEN DOCTOR ID
GO
CREATE FUNCTION LATEST_APPDATE_FOR_THE_GIVEN_DOCTOR (@DOCTOR_ID VARCHAR(6))
RETURNS DATE
AS
BEGIN
	DECLARE @LATEST_APPDATE DATE

	SELECT TOP 1 @LATEST_APPDATE= APP_DATE FROM APPOINTMENT A, DOCTOR D WHERE A.DOCTOR_ID = D.DOCTOR_ID AND D.DOCTOR_ID = 'D1'
	ORDER BY APP_DATE DESC

RETURN @LATEST_APPDATE
END
GO

--FUNCTION CALL TO Q3
DECLARE @LATEST_APPDATE DATE
SET @LATEST_APPDATE = DBO.LATEST_APPDATE_FOR_THE_GIVEN_DOCTOR('D1')
SELECT @LATEST_APPDATE AS 'LATEST APPOINTMENT DATE FOR GIVEN DOCTOR'



--Q4
-- DESCRIBE DOCTOR TABLE
SP_HELP DOCTOR

--QUERY 
SELECT COUNT(A.DOCTOR_ID) FROM APPOINTMENT A, DOCTOR D WHERE A.DOCTOR_ID = D.DOCTOR_ID AND D.DR_FIRST_NAME = 'SOHAN'

-- FUNCTION THAT RETURNS TOTAL APPOINTMENT A PARTICULAR DOCTOR HAVE 
GO
CREATE FUNCTION TOTAL_NO_OF_APPOINTMENTS_FOR_GIVEN_DOCTORNAME(@DOCTOR_FNAME VARCHAR(15))
RETURNS INT
AS
BEGIN
	DECLARE @COUNT INT
	SELECT @COUNT = COUNT(A.DOCTOR_ID) FROM APPOINTMENT A, DOCTOR D WHERE A.DOCTOR_ID = D.DOCTOR_ID AND D.DR_FIRST_NAME = @DOCTOR_FNAME
	RETURN @COUNT
END
GO

-- FUNC CALL TO Q4
DECLARE @COUNT INT
SET @COUNT = DBO.TOTAL_NO_OF_APPOINTMENTS_FOR_GIVEN_DOCTORNAME('VISHHAL')
SELECT @COUNT AS 'TOTAL APPOINTMENTS FOR DOCTOR'



--Q5

--DESCRIBE APPOINTMENT TABLE
SP_HELP APPOINTMENT

--QUERY FOR 5TH QUESTION
SELECT P.P_FIRST_NAME,D.DR_FIRST_NAME,A.APP_DATE FROM APPOINTMENT A, PATIENT P, DOCTOR D
WHERE A.PATIENT_ID = P.PATIENT_ID AND A.DOCTOR_ID = D.DOCTOR_ID AND A.APP_REASON = 'NASAL BLOCK'


--FUNCTION TO SHOW PATIENT NAME, DOCTOR NAME AND APP_DATE WHERE APP_REASON IS GIVEN
GO
CREATE FUNCTION SHOW_PATIENT_DOCTOR_FOR_GIVEN_APPREASON (@APP_REASON VARCHAR(30))
RETURNS @SHOW_TBL TABLE(PFIRST_NAME VARCHAR(15), DFIRST_NAME VARCHAR(15), APP_DATE DATE )
AS
BEGIN
	INSERT @SHOW_TBL
	SELECT P.P_FIRST_NAME,D.DR_FIRST_NAME,A.APP_DATE FROM APPOINTMENT A, PATIENT P, DOCTOR D
	WHERE A.PATIENT_ID = P.PATIENT_ID AND A.DOCTOR_ID = D.DOCTOR_ID AND A.APP_REASON = @APP_REASON
RETURN 
END
GO

-- CALL FUNCTION 5
SELECT * FROM DBO.SHOW_PATIENT_DOCTOR_FOR_GIVEN_APPREASON('NASAL BLOCK');


--QUERY Q4
-- STORED PROCEDURES

--Q1
--DESCRIBE THE PATIENT TABLE
SP_HELP PATIENT;

--QUERY
UPDATE PATIENT SET CONTACT_NUMBER = '123456789' WHERE PATIENT_ID = 'P1';
SELECT * FROM PATIENT;

--PROCEDURE
GO
CREATE PROCEDURE UPDATE_MOB_FOR_GIVEN_PATIENTID (@PATIENT_ID VARCHAR(6), @UPDATED_MOBNO VARCHAR(10))
AS
BEGIN
	DECLARE @CHECK_PID VARCHAR(6)
	SELECT @CHECK_PID = @PATIENT_ID FROM PATIENT P WHERE P.PATIENT_ID = @PATIENT_ID
	
	IF(@CHECK_PID IS NOT NULL)
		UPDATE PATIENT SET CONTACT_NUMBER = @UPDATED_MOBNO 
		WHERE PATIENT_ID = @PATIENT_ID;
	ELSE
		SELECT ' ID NOT FOUND ' AS MESSAGE
END
GO

SELECT * FROM PATIENT;

-- PROCEDURE CALL
EXEC UPDATE_MOB_FOR_GIVEN_PATIENTID 11, 222222222
EXEC UPDATE_MOB_FOR_GIVEN_PATIENTID 'P5', '9999922221'

SELECT * FROM PATIENT;

DECLARE @PATIENT_ID VARCHAR(6);
DECLARE @UPDATED_MOBNO VARCHAR(10);
SET @PATIENT_ID = 'P003';
SET @UPDATED_MOBNO = '1234567890';
EXEC UPDATE_MOB_FOR_GIVEN_PATIENTID @PATIENT_ID,@UPDATED_MOBNO;
	


--Q2

SELECT * FROM BILL;

--QUERY
SELECT P.PATIENT_ID, P.P_FIRST_NAME, P.P_ADDRESS, A.APP_NUMBER , B.BILL_AMOUNT
FROM PATIENT P, APPOINTMENT A, BILL B 
WHERE P.PATIENT_ID = A.PATIENT_ID AND B.APP_NUMBER = A.APP_NUMBER
AND B.BILL_STATUS = 'PENDING'
ORDER BY A.APP_NUMBER DESC;

DROP PROCEDURE SHOW_PATIENT_APP_BILL_WHERE_STATUS_PENDING

-- PROCEDURE WHICH SHOWS PATIENT BILL WHICH ARE NOT PAID OR PENDING
GO
CREATE PROCEDURE SHOW_PATIENT_APP_BILL_WHERE_STATUS_PENDING
AS
BEGIN
	SELECT P.PATIENT_ID, P.P_FIRST_NAME, P.P_ADDRESS, A.APP_NUMBER , B.BILL_AMOUNT
	FROM PATIENT P, APPOINTMENT A, BILL B 
	WHERE P.PATIENT_ID = A.PATIENT_ID AND B.APP_NUMBER = A.APP_NUMBER
	AND B.BILL_STATUS = 'PENDING'
	ORDER BY A.APP_NUMBER DESC;
END
GO

-- PROCEDURE CALL
EXEC SHOW_PATIENT_APP_BILL_WHERE_STATUS_PENDING
SELECT * FROM BILL;

--Q3

SELECT * FROM APPOINTMENT;
SELECT * FROM DOCTOR;

--QUERY
SELECT D.DOCTOR_ID, CONCAT(D.DR_FIRST_NAME, ' ', D.DR_LAST_NAME) AS 'FULL NAME OF DOCTOR' 
FROM DOCTOR D LEFT JOIN APPOINTMENT A ON A.DOCTOR_ID = D.DOCTOR_ID WHERE A.DOCTOR_ID IS NULL
ORDER BY DOCTOR_ID DESC;

-- PROCEDURE WHICH SHOWS ALL THE DOCTORS WHO DON'T HAVE ANY APPOINTMENT
GO
CREATE PROCEDURE SHOW_DOCTOR_WHO_HAVE_NO_APPOINTMENTS
AS
BEGIN
	SELECT D.DOCTOR_ID, CONCAT(D.DR_FIRST_NAME, ' ', D.DR_LAST_NAME) AS 'FULL NAME OF DOCTOR' 
	FROM DOCTOR D LEFT JOIN APPOINTMENT A ON A.DOCTOR_ID = D.DOCTOR_ID WHERE A.DOCTOR_ID IS NULL
	ORDER BY DOCTOR_ID DESC;
END
GO

-- PROCEDURE CALL
EXEC SHOW_DOCTOR_WHO_HAVE_NO_APPOINTMENTS

--Q4
use marathon;

--QUERY
SELECT CONCAT(P.P_FIRST_NAME,' ', P.P_LAST_NAME) AS 'PATIENT FULL NAME',  A.APP_DATE, CONCAT(D.DR_FIRST_NAME,' ', D.DR_LAST_NAME) AS 'DOCTOR FULL NAME'
FROM PATIENT P, APPOINTMENT A, DOCTOR D 
WHERE P.PATIENT_ID = A.PATIENT_ID AND A.DOCTOR_ID = D.DOCTOR_ID
AND P.CITY = 'RAHATA';

--DECRIBE THE PATIENT TABLE
SP_HELP PATIENT

-- PROCEDURE WHICH FINDS ALL THE APPOINTMENTS FOR THE PATIENTS LIVING IN A SPECIFIC AREA
GO
CREATE PROCEDURE SHOW_ALL_APPOINTMENTS_FOR_PATIENTS_LIVING_IN_GIVEN_AREA(@CITY VARCHAR(15))
AS
BEGIN
	SELECT CONCAT(P.P_FIRST_NAME,' ', P.P_LAST_NAME) AS 'PATIENT FULL NAME',  A.APP_DATE, CONCAT(D.DR_FIRST_NAME,' ', D.DR_LAST_NAME) AS 'DOCTOR FULL NAME'
	FROM PATIENT P, APPOINTMENT A, DOCTOR D 
	WHERE P.PATIENT_ID = A.PATIENT_ID AND A.DOCTOR_ID = D.DOCTOR_ID
	AND P.CITY = @CITY;
END
GO

--PROCEDURE CALL
EXEC SHOW_ALL_APPOINTMENTS_FOR_PATIENTS_LIVING_IN_GIVEN_AREA 'RAHATA'

--Q5

SELECT * FROM PATIENT;
SELECT * FROM PAYMENT;
SELECT * FROM BILL;
SELECT * FROM APPOINTMENT;
--QUERY
SELECT SUM(PAY.PAY_AMOUNT) 'TOTAL BILL PAID' 
FROM PATIENT P, APPOINTMENT A, BILL B, PAYMENT PAY
WHERE P.PATIENT_ID = 'P2' AND P.PATIENT_ID = A.PATIENT_ID AND A.APP_NUMBER = B.APP_NUMBER 
AND PAY.BILL_NUMBER = B.BILL_NUMBER

--PROCEDURE TO GET THE TOTAL BILL AMOUNT PAID BY THE PATIENT

DROP PROC SHOW_TOTAL_BILL_PAID

GO
CREATE PROCEDURE SHOW_TOTAL_BILL_PAID(@PATIENT_ID VARCHAR(6), @TOTAL_BILL_AMOUNT DECIMAL(7,2) OUT)
AS
BEGIN
	SELECT SUM(PAY.PAY_AMOUNT) 'TOTAL BILL PAID' 
	FROM PATIENT P, APPOINTMENT A, BILL B, PAYMENT PAY
	WHERE P.PATIENT_ID = @PATIENT_ID AND P.PATIENT_ID = A.PATIENT_ID AND A.APP_NUMBER = B.APP_NUMBER 
	AND PAY.BILL_NUMBER = B.BILL_NUMBER
END
GO

--DESCRIBE THE PAYMENT TABLE
SP_HELP PAYMENT;

-- PROCEDURE CALL
DECLARE @TOTAL_BILL_AMOUNT DECIMAL(7,2)
DECLARE @PATIENT_ID VARCHAR(6)
SET @PATIENT_ID ='P3'
EXEC SHOW_TOTAL_BILL_PAID @PATIENT_ID, @TOTAL_BILL_AMOUNT

--QUERY Q5
--VIEWS

--Q1
DROP VIEW V_PATIENTS_DOCTORS_APPOINTMENTS 
--CREATING A VIEW DISPLAYING PATIENT'S, DOCTOR'S, APPOINTMENT DETAILS
CREATE VIEW V_PATIENTS_DOCTORS_APPOINTMENTS AS 
SELECT P.P_FIRST_NAME AS 'PATIENT FIRSTNAME', P.P_LAST_NAME 'PATIENT LASTNAME', P.P_AGE 'PATIENT AGE', D.DR_FIRST_NAME 'DOCTOR FIRSTNAME', A.APP_DATE 'APPOINTMENT DATE', A.APP_TIME 'APPOINTMENT TIME' 
FROM PATIENT P, DOCTOR D, APPOINTMENT A
WHERE P.PATIENT_ID = A.PATIENT_ID AND D.DOCTOR_ID = A.DOCTOR_ID;

SELECT * FROM V_PATIENTS_DOCTORS_APPOINTMENTS;

--Q2

CREATE VIEW V_PATIENT_BILL_PAYMENT_DETAILS AS
SELECT P.PATIENT_ID AS 'PATIENT ID',P.P_FIRST_NAME 'PATIENT FIRSTNAME',P.P_LAST_NAME 'PATIENT LASTNAME',P.CITY 'PATIENT CITY', 
B.BILL_AMOUNT 'BILL AMOUNT' , B.BILL_STATUS 'BILL STATUS',B.BILL_DATE 'BILL DATE',
PAY.PAY_AMOUNT,PAY.PAY_MODE
FROM PATIENT P, APPOINTMENT A, BILL B, PAYMENT PAY
WHERE P.PATIENT_ID = A.PATIENT_ID AND A.APP_NUMBER = B.APP_NUMBER AND B.BILL_NUMBER = PAY.BILL_NUMBER

SELECT * FROM V_PATIENT_BILL_PAYMENT_DETAILS;



--Q3

CREATE VIEW V_DOCTOR_AND_THEIR_APPOINTMENTS AS 
SELECT D.DOCTOR_ID,D.DR_FIRST_NAME,D.DR_LAST_NAME,
A.APP_NUMBER,A.PATIENT_ID,A.APP_DATE,A.APP_TIME,A.APP_REASON
FROM DOCTOR D, APPOINTMENT A 
WHERE D.DOCTOR_ID = A.DOCTOR_ID;

SELECT * FROM V_DOCTOR_AND_THEIR_APPOINTMENTS;

--Q4

-- VIEW WHICH INCLUDES DOCTOR NAME, PATIENT P
CREATE VIEW V_DOCTORNAME_PATIENTNAME_AND_APPOINTMENT_DETAILS AS
SELECT D.DR_FIRST_NAME,D.DR_LAST_NAME, P.P_FIRST_NAME,P.P_LAST_NAME,A.APP_DATE,A.APP_TIME,A.APP_REASON
FROM DOCTOR D, PATIENT P, APPOINTMENT A
WHERE D.DOCTOR_ID = A.DOCTOR_ID AND P.PATIENT_ID = A.PATIENT_ID;

SELECT * FROM V_DOCTORNAME_PATIENTNAME_AND_APPOINTMENT_DETAILS;

--Q5

--VIEW WHICH INCLUDES PATIENTS AND PAYMENT DETAILS WHICH WERE PAID SUCCESSFULLY
CREATE VIEW V_PATIENT_PAYMENT_SUCCESSFUL AS
SELECT P.PATIENT_ID,P.P_FIRST_NAME,P.P_LAST_NAME,P_AGE,A.APP_NUMBER,A.APP_DATE,A.APP_TIME,A.DOCTOR_ID,
B.BILL_NUMBER,B.BILL_DATE,B.BILL_AMOUNT,B.BILL_STATUS
FROM PATIENT P, APPOINTMENT A, BILL B
WHERE P.PATIENT_ID = A.PATIENT_ID AND A.APP_NUMBER = B.APP_NUMBER AND BILL_STATUS = 'SUCCESSFUL';

--DISPLAYING VIEW
SELECT * FROM V_PATIENT_PAYMENT_SUCCESSFUL;




